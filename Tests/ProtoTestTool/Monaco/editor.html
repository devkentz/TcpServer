<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco Editor</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1e1e1e;
        }

        #container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="container"></div>

    <!-- Load Monaco Editor from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });

        let editor;

        // Completion Items
        let completionItems = [];

        require(['vs/editor/editor.main'], function () {
            // Register Provider
            monaco.languages.registerCompletionItemProvider('csharp', {
                provideCompletionItems: function (model, position) {
                    return { suggestions: completionItems };
                }
            });

            editor = monaco.editor.create(document.getElementById('container'), {
                value: "// Loading...",
                language: 'csharp',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: true },
                fontSize: 14,
                fontFamily: 'Consolas, "Courier New", monospace',
                scrollBeyondLastLine: false,
                renderWhitespace: "none",
                contextmenu: true
            });

            // Notify C# that editor is ready
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({ type: 'ready' });
            }
        });

        // --- Interop Functions called from C# ---

        function updateCompletions(json) {
            try {
                if (typeof json === 'string') {
                    completionItems = JSON.parse(json);
                } else {
                    completionItems = json;
                }
            } catch (e) {
                console.error("Failed to parse completions", e);
            }
        }

        function setContent(content) {
            if (editor) {
                editor.setValue(content);
            } else {
                setTimeout(() => setContent(content), 100);
            }
        }

        function setLanguage(lang) {
            if (editor && monaco) {
                monaco.editor.setModelLanguage(editor.getModel(), lang);
            }
        }

        function getContent() {
            if (editor) {
                return editor.getValue();
            }
            return "";
        }

        function setTheme(themeName) {
            if (monaco) {
                monaco.editor.setTheme(themeName);
            }
        }

        function layout() {
            if (editor) {
                editor.layout();
            }
        }
    </script>
</body>

</html>